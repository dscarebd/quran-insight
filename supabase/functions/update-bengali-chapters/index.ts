import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

// Bengali translations for chapter names
const chapterTranslations: Record<string, Record<number, string>> = {
  bukhari: {
    1: "ওয়াহী (প্রত্যাদেশ)",
    2: "ঈমান",
    3: "ইলম (জ্ঞান)",
    4: "অযু",
    5: "গোসল",
    6: "হায়েয (ঋতুস্রাব)",
    7: "তায়াম্মুম",
    8: "সালাত (নামায)",
    9: "সালাতের ওয়াক্তসমূহ",
    10: "আযান",
    11: "জুমুআর সালাত",
    12: "খাওফ (ভয়) এর সালাত",
    13: "দুই ঈদ",
    14: "বিতর সালাত",
    15: "ইস্তিস্কা (বৃষ্টির জন্য দোয়া)",
    16: "সূর্যগ্রহণ ও চন্দ্রগ্রহণ",
    17: "কুরআন তিলাওয়াতে সিজদা",
    18: "সালাত কসর করা",
    19: "তাহাজ্জুদ (রাতের নামায)",
    20: "মক্কা ও মদিনার মসজিদে নামাযের ফযিলত",
    21: "কাজে প্রতিনিধি নিয়োগ",
    22: "জানাযা",
    23: "যাকাত",
    24: "সাদাকাতুল ফিতর",
    25: "হজ্জ",
    26: "উমরা",
    27: "মুহসার ও শিকারের জরিমানা",
    28: "মদিনার ফযিলত",
    29: "রোযা",
    30: "তারাবীহ",
    31: "লাইলাতুল কদরের ফযিলত",
    32: "ইতিকাফ",
    33: "বেচাকেনা",
    34: "সালাম (অগ্রিম ক্রয়)",
    35: "শুফআ (প্রাধান্য ক্রয়)",
    36: "ইজারা (ভাড়া)",
    37: "হাওয়ালা",
    38: "কাফালা",
    39: "ওয়াকালাত",
    40: "মুযারাআ",
    41: "পানি সেচ",
    42: "ঋণ",
    43: "ঝগড়া-বিবাদ",
    44: "পড়ে থাকা জিনিস",
    45: "জুলুম ও কিসাস",
    46: "অংশীদারিত্ব",
    47: "বন্ধক",
    48: "দাস মুক্তি",
    49: "মুকাতাব",
    50: "হিবা ও এর ফযিলত",
    51: "সাক্ষ্য",
    52: "সন্ধি",
    53: "শর্তাবলী",
    54: "অসিয়ত",
    55: "জিহাদ ও সিয়ার",
    56: "খুমুস (এক-পঞ্চমাংশ)",
    57: "জিযিয়া",
    58: "সৃষ্টির সূচনা",
    59: "আম্বিয়া (নবীগণ)",
    60: "মর্যাদা ও গুণাবলী",
    61: "সাহাবীদের মর্যাদা",
    62: "আনসারদের মর্যাদা",
    63: "মাগাযী (যুদ্ধাভিযান)",
    64: "তাফসীর",
    65: "কুরআনের ফযিলত",
    66: "বিবাহ",
    67: "তালাক",
    68: "খোরপোষ",
    69: "খাদ্যদ্রব্য",
    70: "আকীকা",
    71: "শিকার ও যবেহ",
    72: "কুরবানী",
    73: "পানীয়",
    74: "রোগী",
    75: "চিকিৎসা",
    76: "পোশাক",
    77: "শিষ্টাচার",
    78: "অনুমতি প্রার্থনা",
    79: "দোয়া",
    80: "হৃদয় নরম করা",
    81: "তাকদীর",
    82: "শপথ ও মানত",
    83: "শপথের কাফফারা",
    84: "মীরাস (উত্তরাধিকার)",
    85: "হুদুদ (দণ্ড)",
    86: "মুরতাদ ও যুদ্ধকারীদের শাস্তি",
    87: "দিয়াত (রক্তপণ)",
    88: "কাফেরদের সাথে আচরণ",
    89: "বাধ্য করা",
    90: "কৌশল",
    91: "স্বপ্নের ব্যাখ্যা",
    92: "ফিতনা",
    93: "বিচার",
    94: "ইচ্ছা ও আকাঙ্ক্ষা",
    95: "খবরে ওয়াহিদ",
    96: "কুরআন ও সুন্নাহ আঁকড়ে ধরা",
    97: "তাওহীদ",
  },
  muslim: {
    1: "ঈমান",
    2: "পবিত্রতা",
    3: "হায়েয (ঋতুস্রাব)",
    4: "সালাত (নামায)",
    5: "মসজিদ ও সালাতের স্থান",
    6: "মুসাফিরদের সালাত ও কসর",
    7: "জুমুআ",
    8: "দুই ঈদের সালাত",
    9: "ইস্তিস্কা (বৃষ্টির দোয়া)",
    10: "সূর্যগ্রহণের সালাত",
    11: "জানাযা",
    12: "যাকাত",
    13: "রোযা",
    14: "ইতিকাফ",
    15: "হজ্জ",
    16: "বিবাহ",
    17: "দুধপান",
    18: "তালাক",
    19: "লিআন",
    20: "দাস মুক্তি",
    21: "বেচাকেনা",
    22: "মুসাকাত ও মুযারাআ",
    23: "মীরাস (উত্তরাধিকার)",
    24: "হিবা (উপহার)",
    25: "অসিয়ত",
    26: "মানত",
    27: "শপথ",
    28: "কাসামা",
    29: "হুদুদ (দণ্ড)",
    30: "বিচার",
    31: "পড়ে থাকা জিনিস",
    32: "জিহাদ ও সিয়ার",
    33: "ইমারাত (নেতৃত্ব)",
    34: "শিকার ও যবেহ",
    35: "কুরবানী",
    36: "পানীয়",
    37: "পোশাক ও সাজসজ্জা",
    38: "আদব (শিষ্টাচার)",
    39: "সালাম",
    40: "শব্দ ও আদব",
    41: "কবিতা",
    42: "স্বপ্ন",
    43: "ফাযায়েল (ফযিলত)",
    44: "সাহাবীদের ফযিলত",
    45: "সদ্ব্যবহার ও সম্পর্ক",
    46: "তাকদীর",
    47: "ইলম (জ্ঞান)",
    48: "যিকির ও দোয়া",
    49: "তাওবা",
    50: "মুনাফিকদের বৈশিষ্ট্য",
    51: "কিয়ামতের বর্ণনা",
    52: "জান্নাত",
    53: "ফিতনা ও কিয়ামতের আলামত",
    54: "যুহদ ও হৃদয় নরম করা",
    55: "তাফসীর",
    56: "ফাযায়েলুল কুরআন",
    57: "সংক্ষিপ্ত দোয়া",
  },
  abudawud: {
    1: "পবিত্রতা",
    2: "সালাত (নামায)",
    3: "ইস্তিস্কা (বৃষ্টির দোয়া)",
    4: "সফরের সালাত",
    5: "নফল সালাত",
    6: "রমযানের বিধান",
    7: "কুরআন তিলাওয়াতে সিজদা",
    8: "বিতরের বিস্তারিত বিধান",
    9: "যাকাত",
    10: "হারানো জিনিস",
    11: "হজ্জের বিধান",
    12: "বিবাহ",
    13: "তালাক",
    14: "রোযা",
    15: "জিহাদ",
    16: "কুরবানী",
    17: "শিকার",
    18: "অসিয়ত",
    19: "মীরাস (উত্তরাধিকার)",
    20: "খারাজ, ফাই ও ইমারাত",
    21: "জানাযা",
    22: "শপথ ও মানত",
    23: "বেচাকেনা",
    24: "ভাড়া",
    25: "বিচার",
    26: "ইলম (জ্ঞান)",
    27: "পানীয়",
    28: "খাদ্যদ্রব্য",
    29: "চিকিৎসা",
    30: "জ্যোতিষ ও কুলক্ষণ",
    31: "দাস মুক্তি",
    32: "কুরআনের উচ্চারণ ও পাঠ",
    33: "হাম্মাম (গোসলখানা)",
    34: "পোশাক",
    35: "চুল আঁচড়ানো",
    36: "আংটি",
    37: "ফিতনা ও যুদ্ধ",
    38: "ইমাম মাহদী",
    39: "যুদ্ধ",
    40: "হুদুদ (দণ্ড)",
    41: "দিয়াত (রক্তপণ)",
    42: "সুন্নাহ",
    43: "আদব (শিষ্টাচার)",
  },
  tirmidhi: {
    1: "পবিত্রতা",
    2: "সালাত (নামায)",
    3: "বিতর",
    4: "জুমুআ",
    5: "যাকাত",
    6: "রোযা",
    7: "হজ্জ",
    8: "জানাযা",
    9: "বিবাহ",
    10: "দুধপান",
    11: "তালাক ও লিআন",
    12: "বেচাকেনা",
    13: "বিচার",
    14: "রক্তপণ",
    15: "হুদুদ (দণ্ড)",
    16: "শিকার",
    17: "কুরবানী",
    18: "মানত ও শপথ",
    19: "সিয়ার",
    20: "জিহাদের ফযিলত",
    21: "পোশাক",
    22: "খাদ্যদ্রব্য",
    23: "পানীয়",
    24: "সদ্ব্যবহার ও সম্পর্ক",
    25: "চিকিৎসা",
    26: "মীরাস (উত্তরাধিকার)",
    27: "অসিয়ত",
    28: "ওয়ালা ও হিবা",
    29: "তাকদীর",
    30: "ফিতনা",
    31: "স্বপ্ন",
    32: "সাক্ষ্য",
    33: "যুহদ",
    34: "কিয়ামতের বর্ণনা",
    35: "জান্নাতের বর্ণনা",
    36: "জাহান্নামের বর্ণনা",
    37: "ঈমান",
    38: "ইলম (জ্ঞান)",
    39: "অনুমতি প্রার্থনা ও আদব",
    40: "আদব (শিষ্টাচার)",
    41: "দৃষ্টান্ত",
    42: "রাসূল (সা.) এর ফযিলত",
    43: "মর্যাদা",
  },
  nasai: {
    1: "পবিত্রতা",
    2: "পানি",
    3: "হায়েয ও ইস্তিহাযা",
    4: "গোসল ও তায়াম্মুম",
    5: "সালাত (নামায)",
    6: "সালাতের সময়",
    7: "আযান",
    8: "মসজিদ",
    9: "কিবলা",
    10: "ইমামত",
    11: "সালাতের সূচনা",
    12: "তাতবীক",
    13: "বিস্মৃতি",
    14: "জুমুআ",
    15: "গ্রহণের সালাত",
    16: "ইস্তিস্কা",
    17: "দুই ঈদ",
    18: "কিয়ামুল লাইল",
    19: "সালাত কসর করা",
    20: "জানাযা",
    21: "যাকাত",
    22: "রোযা",
    23: "ইতিকাফ",
    24: "হজ্জের বিধান",
    25: "জিহাদ",
    26: "বিবাহ",
    27: "তালাক",
    28: "ঘোড়া",
    29: "হিবা",
    30: "অসিয়ত",
    31: "মানত ও শপথ",
    32: "মীরাস",
    33: "হুদুদ ও দিয়াত",
    34: "বেচাকেনা",
    35: "আকীকা",
    36: "ফারা ও আতীরা",
    37: "শিকার ও যবেহ",
    38: "কুরবানী",
    39: "ঈমান ও শরীয়ত",
    40: "সাজসজ্জা",
    41: "আদব",
    42: "বিচার",
    43: "কুরআন তিলাওয়াতে সিজদা",
    44: "খাদ্যদ্রব্য",
    45: "পানীয়",
    46: "দাস মুক্তি",
    47: "বায়আত",
    48: "ইস্তিআযা",
    49: "স্বর্ণ ও রূপা",
    50: "সৃষ্টির সূচনা",
    51: "তাতবীক",
    52: "জিহাদের ফযিলত",
  },
  ibnmajah: {
    1: "মুকাদ্দিমা (ভূমিকা)",
    2: "পবিত্রতা",
    3: "সালাত (নামায)",
    4: "আযান",
    5: "মসজিদ ও জামাআত",
    6: "সালাত প্রতিষ্ঠা",
    7: "জানাযা",
    8: "রোযা",
    9: "যাকাত",
    10: "বিবাহ",
    11: "তালাক",
    12: "কাফফারা",
    13: "বেচাকেনা",
    14: "বিচার",
    15: "হিবা (উপহার)",
    16: "সাদাকা",
    17: "বন্ধক",
    18: "শুফআ",
    19: "লুকতা",
    20: "দাস মুক্তি",
    21: "হুদুদ (দণ্ড)",
    22: "দিয়াত (রক্তপণ)",
    23: "অসিয়ত",
    24: "মীরাস",
    25: "জিহাদ",
    26: "হজ্জের বিধান",
    27: "কুরবানী",
    28: "যবেহ",
    29: "শিকার",
    30: "খাদ্যদ্রব্য",
    31: "পানীয়",
  },
  malik: {
    1: "সালাতের সময়",
    2: "পবিত্রতা",
    3: "সালাত (নামায)",
    4: "বিস্মৃতি",
    5: "জুমুআ",
    6: "রমযানে সালাত",
    7: "কুরআন তিলাওয়াতে সিজদা",
    8: "বিতর",
    9: "দুই ঈদ",
    10: "সালাত কসর করা",
    11: "গ্রহণের সালাত",
    12: "ইস্তিস্কা",
    13: "কিবলা",
    14: "কুরআন",
    15: "জানাযা",
    16: "যাকাত",
    17: "ইতিকাফ",
    18: "রোযা",
    19: "জিহাদ",
    20: "মানত ও শপথ",
    21: "কুরবানী",
    22: "যবেহ",
    23: "শিকার",
    24: "আকীকা",
    25: "ফারাইদ",
    26: "বিবাহ",
    27: "তালাক",
    28: "দুধপান",
    29: "বেচাকেনা",
    30: "কিরা",
    31: "মুসাকাত",
    32: "শুফআ",
    33: "বিচার",
    34: "অসিয়ত",
    35: "ইতক ও ওয়ালা",
    36: "মুকাতাব",
    37: "মুদাব্বার",
    38: "হুদুদ",
    39: "পানীয়",
    40: "উকুল",
    41: "চুল ও পোশাক",
    42: "কালাম",
    43: "জামিউ",
    44: "কদর",
    45: "আখলাক",
    46: "কিয়ামুল লাইল",
    47: "দোয়া",
    48: "কুরআন তিলাওয়াত",
    49: "শাম",
    50: "মদিনা",
    51: "আইন",
    52: "হজ্জ",
    53: "সালাম",
    54: "জাহিলিয়া",
    55: "সদকা",
    56: "কসম",
    57: "নিকাহ",
    58: "ক্রীতদাস",
    59: "ইহরাম",
    60: "হিবা",
    61: "সফর",
  },
  nawawi: {
    1: "চল্লিশ হাদীস",
  },
  qudsi: {
    1: "হাদীসে কুদসী",
  },
  dehlawi: {
    1: "মিশকাতুল মাসাবীহ",
  },
};

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    const { bookSlug } = await req.json();

    let booksToUpdate = bookSlug ? [bookSlug] : Object.keys(chapterTranslations);
    let totalUpdated = 0;
    const results: Record<string, number> = {};

    for (const book of booksToUpdate) {
      const translations = chapterTranslations[book];
      if (!translations) continue;

      let bookUpdated = 0;

      for (const [chapterNum, bengaliName] of Object.entries(translations)) {
        const { error, count } = await supabase
          .from("hadiths")
          .update({ chapter_name_bengali: bengaliName })
          .eq("book_slug", book)
          .eq("chapter_number", parseInt(chapterNum));

        if (error) {
          console.error(`Error updating ${book} chapter ${chapterNum}:`, error);
        } else {
          bookUpdated += count || 0;
        }
      }

      results[book] = bookUpdated;
      totalUpdated += bookUpdated;
    }

    return new Response(
      JSON.stringify({
        success: true,
        message: `Updated ${totalUpdated} hadiths with Bengali chapter names`,
        results,
      }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (error: unknown) {
    console.error("Error:", error);
    const errorMessage = error instanceof Error ? error.message : "Unknown error";
    return new Response(
      JSON.stringify({ success: false, error: errorMessage }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 500 }
    );
  }
});
